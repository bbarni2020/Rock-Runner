<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rock Runner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-color: rgba(255, 255, 0, 1);
            --theme-color-dim: rgba(255, 255, 0, 0.8);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: radial-gradient(ellipse at center, #1a1a1a 0%, #0d0d0d 40%, #000000 100%);
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            font-family: 'Orbitron', 'Exo 2', monospace;
            overflow: hidden;
            position: relative;
            animation: backgroundShift 20s ease-in-out infinite;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(ellipse at center, #1a1a1a 0%, #0d0d0d 40%, #000000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            font-family: 'Orbitron', monospace;
            color: #ffff00;
            transition: opacity 1s ease-in-out;
        }

        .loading-title {
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 8px;
            margin-bottom: 40px;
            text-shadow: 
                0 0 20px rgba(255, 255, 0, 0.8),
                0 0 40px rgba(255, 255, 0, 0.6),
                0 0 60px rgba(255, 255, 0, 0.4);
            animation: titlePulse 2s ease-in-out infinite;
            text-transform: uppercase;
        }

        .loading-bar-container {
            width: 400px;
            height: 8px;
            background: rgba(255, 255, 0, 0.2);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 0, 0.5);
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.3);
        }

        .loading-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffff00, #ffff66, #ffff00);
            border-radius: 8px;
            transition: width 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.8);
            animation: barGlow 1.5s ease-in-out infinite;
        }

        .loading-text {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 3px;
            margin-bottom: 20px;
            opacity: 0.8;
            animation: textFade 2s ease-in-out infinite;
        }

        .control-message {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 4px;
            color: #00ff00;
            opacity: 0;
            transform: scale(0.8);
            text-shadow: 
                0 0 20px rgba(0, 255, 0, 0.8),
                0 0 40px rgba(0, 255, 0, 0.6);
            animation: controlAppear 2s ease-out forwards;
            text-transform: uppercase;
            margin-top: 20px;
        }

        .start-prompt {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 2px;
            color: #ffff00;
            opacity: 0;
            margin-top: 30px;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.6);
            animation: promptBlink 1.5s ease-in-out infinite;
        }

        @keyframes promptBlink {
            0%, 100% { 
                opacity: 0.6; 
                transform: scale(1);
            }
            50% { 
                opacity: 1; 
                transform: scale(1.05);
            }
        }

        .loading-stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 20px 30px, rgba(255, 255, 0, 0.8), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255, 255, 0, 0.6), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255, 255, 0, 0.9), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255, 255, 0, 0.4), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(255, 255, 0, 0.7), transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: loadingStars 10s linear infinite;
            z-index: -1;
        }

        @keyframes titlePulse {
            0%, 100% {
                text-shadow: 
                    0 0 20px rgba(255, 255, 0, 0.8),
                    0 0 40px rgba(255, 255, 0, 0.6),
                    0 0 60px rgba(255, 255, 0, 0.4);
                transform: scale(1);
            }
            50% {
                text-shadow: 
                    0 0 30px rgba(255, 255, 0, 1),
                    0 0 50px rgba(255, 255, 0, 0.8),
                    0 0 70px rgba(255, 255, 0, 0.6);
                transform: scale(1.05);
            }
        }

        @keyframes barGlow {
            0%, 100% {
                box-shadow: 0 0 15px rgba(255, 255, 0, 0.8);
            }
            50% {
                box-shadow: 0 0 25px rgba(255, 255, 0, 1);
            }
        }

        @keyframes textFade {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes controlAppear {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1) translateY(-5px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes loadingStars {
            0% { 
                background-position: 0 0;
                transform: translateY(0);
            }
            100% { 
                background-position: 0 100px;
                transform: translateY(-10px);
            }
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .loading-title {
                font-size: 32px;
                letter-spacing: 4px;
            }
            
            .loading-bar-container {
                width: 300px;
            }
            
            .control-message {
                font-size: 24px;
                letter-spacing: 2px;
            }
            
            .loading-text {
                font-size: 16px;
            }
            
            .start-prompt {
                font-size: 16px;
                letter-spacing: 1px;
                margin-top: 20px;
            }
        }

        @keyframes backgroundShift {
            0%, 100% { 
                background: radial-gradient(ellipse at center, #1a1a1a 0%, #0d0d0d 40%, #000000 100%);
                transform: scale(1);
            }
            50% { 
                background: radial-gradient(ellipse at 40% 60%, #1a1a1a 0%, #0d0d0d 40%, #000000 100%);
                transform: scale(1.02);
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 20px 30px, rgba(255, 255, 0, 0.8), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255, 255, 0, 0.6), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255, 255, 0, 0.9), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255, 255, 0, 0.4), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(255, 255, 0, 0.7), transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: twinkle 3s infinite, slowStarMove 20s linear infinite, starShift 12s ease-in-out infinite, verticalDrift 8s ease-in-out infinite;
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 60px 50px, rgba(255, 255, 0, 0.3), transparent),
                radial-gradient(1px 1px at 120px 90px, rgba(255, 255, 0, 0.5), transparent),
                radial-gradient(2px 2px at 180px 120px, rgba(255, 255, 0, 0.2), transparent);
            background-repeat: repeat;
            background-size: 300px 150px;
            animation: slowStarMove2 35s linear infinite, starShift2 15s ease-in-out infinite, verticalDrift2 10s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes verticalDrift {
            0%, 100% { 
                background-position-y: 0px;
            }
            25% { 
                background-position-y: -15px;
            }
            50% { 
                background-position-y: 10px;
            }
            75% { 
                background-position-y: -8px;
            }
        }

        @keyframes verticalDrift2 {
            0%, 100% { 
                background-position-y: 0px;
            }
            30% { 
                background-position-y: 12px;
            }
            60% { 
                background-position-y: -10px;
            }
            85% { 
                background-position-y: 6px;
            }
        }

        @keyframes starShift {
            0%, 100% { 
                transform: translateX(0) translateY(0) scale(1);
            }
            25% { 
                transform: translateX(-8px) translateY(-12px) scale(1.01);
            }
            50% { 
                transform: translateX(5px) translateY(8px) scale(0.99);
            }
            75% { 
                transform: translateX(8px) translateY(-5px) scale(1.02);
            }
        }

        @keyframes starShift2 {
            0%, 100% { 
                transform: translateX(0) translateY(0) scale(1);
            }
            20% { 
                transform: translateX(6px) translateY(-10px) scale(1.02);
            }
            40% { 
                transform: translateX(-4px) translateY(6px) scale(0.98);
            }
            60% { 
                transform: translateX(-8px) translateY(-8px) scale(1.01);
            }
            80% { 
                transform: translateX(10px) translateY(12px) scale(0.99);
            }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @keyframes slowStarMove {
            0% { 
                background-position: 0 0;
                transform: translateY(0);
            }
            33% { 
                background-position: 0 33px;
                transform: translateY(-4px);
            }
            66% { 
                background-position: 0 66px;
                transform: translateY(3px);
            }
            100% { 
                background-position: 0 100px;
                transform: translateY(0);
            }
        }

        @keyframes slowStarMove2 {
            0% { 
                background-position: 0 0;
                transform: translateY(0);
            }
            25% { 
                background-position: 0 37px;
                transform: translateY(2px);
            }
            50% { 
                background-position: 0 75px;
                transform: translateY(-5px);
            }
            75% { 
                background-position: 0 112px;
                transform: translateY(3px);
            }
            100% { 
                background-position: 0 150px;
                transform: translateY(0);
            }
        }

        .game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, 
                rgba(0, 0, 0, 0.05) 0%, 
                rgba(10, 10, 0, 0.02) 30%, 
                rgba(0, 0, 0, 0.1) 100%);
            border: none;
            border-radius: 0;
            overflow: hidden;
            box-shadow: none;
            animation: containerFloat 12s ease-in-out infinite;
        }

        @keyframes containerFloat {
            0%, 100% { 
                transform: translateY(0) scale(1);
            }
            50% { 
                transform: translateY(-3px) scale(1.001);
            }
        }

        .road {
            position: absolute;
            width: 100%;
            height: 100%;
            background: transparent;
            background-image: 
                radial-gradient(1px 1px at 10% 20%, rgba(255, 255, 0, 0.9), transparent),
                radial-gradient(2px 2px at 25% 40%, rgba(255, 255, 0, 0.7), transparent),
                radial-gradient(1px 1px at 40% 10%, rgba(255, 255, 0, 0.8), transparent),
                radial-gradient(3px 3px at 60% 30%, rgba(255, 255, 0, 0.6), transparent),
                radial-gradient(1px 1px at 75% 60%, rgba(255, 255, 0, 0.9), transparent),
                radial-gradient(2px 2px at 90% 80%, rgba(255, 255, 0, 0.5), transparent),
                radial-gradient(1px 1px at 15% 70%, rgba(255, 255, 0, 0.7), transparent),
                radial-gradient(2px 2px at 85% 15%, rgba(255, 255, 0, 0.8), transparent);
            background-size: 100vw 100vh;
            animation: starsMove 15s linear infinite;
        }

        @keyframes starsMove {
            0% { 
                background-position: 0 -100vh;
                transform: scale(0.8) translateX(0) translateY(0);
            }
            25% { 
                background-position: 0 -25vh;
                transform: scale(0.95) translateX(-3px) translateY(-8px);
            }
            50% { 
                background-position: 0 50vh;
                transform: scale(1.1) translateX(3px) translateY(5px);
            }
            75% { 
                background-position: 0 125vh;
                transform: scale(1.15) translateX(-2px) translateY(-3px);
            }
            100% { 
                background-position: 0 200vh;
                transform: scale(1.2) translateX(0) translateY(0);
            }
        }

        .lane-lines {
            position: absolute;
            width: 100%;
            height: 100%;
            background: transparent;
            animation: none;
        }

        .car {
            width: 60px;
            height: 120px;
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            transition: transform 0.2s ease-out, filter 0.5s ease-out;
            z-index: 10;
            filter: drop-shadow(0 0 15px rgba(255, 255, 0, 0.3));
        }

        .car-body {
            width: 100%;
            height: 80%;
            background: linear-gradient(to bottom, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            border-radius: 50% 50% 10px 10px;
            position: relative;
            border: 2px solid #ffff00;
            box-shadow: 
                0 0 20px rgba(255, 255, 0, 0.6),
                inset 0 0 10px rgba(255, 255, 0, 0.2);
        }

        .car-windshield {
            width: 70%;
            height: 40%;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 0, 0.8) 0%, 
                rgba(255, 255, 0, 0.6) 50%, 
                rgba(255, 255, 0, 0.4) 100%);
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 50% 50% 20px 20px;
            border: 1px solid #ffff00;
            box-shadow: 
                0 0 15px rgba(255, 255, 0, 0.6),
                inset 0 0 10px rgba(255, 255, 0, 0.1);
        }

        .car-wheels {
            position: absolute;
            width: 100%;
            height: 20%;
            bottom: 0;
        }

        .wheel {
            width: 12px;
            height: 30px;
            background: linear-gradient(to bottom, #ffff00 0%, #cccc00 50%, #ffff00 100%);
            border: 1px solid #999900;
            border-radius: 6px;
            position: absolute;
            bottom: 0;
            box-shadow: 
                0 0 10px rgba(255, 255, 0, 0.8),
                inset 0 0 5px rgba(255, 255, 255, 0.3);
            animation: thruster 0.1s infinite alternate;
        }

        @keyframes thruster {
            0% { 
                box-shadow: 
                    0 0 10px var(--theme-color-dim),
                    inset 0 0 5px rgba(255, 255, 255, 0.3);
                height: 30px;
                transform: scaleY(1);
            }
            100% { 
                box-shadow: 
                    0 0 15px var(--theme-color),
                    inset 0 0 8px rgba(255, 255, 255, 0.4);
                height: 35px;
                transform: scaleY(1.1);
            }
        }

        @keyframes thrusterBoost {
            0%, 100% {
                box-shadow: 
                    0 0 15px var(--theme-color),
                    inset 0 0 8px rgba(255, 255, 255, 0.4);
                height: 35px;
                transform: scaleY(1.1);
            }
            50% {
                box-shadow: 
                    0 0 25px var(--theme-color),
                    inset 0 0 12px rgba(255, 255, 255, 0.6);
                height: 45px;
                transform: scaleY(1.3);
            }
        }

        .wheel.front-left { left: 8px; }
        .wheel.front-right { right: 8px; }
        .wheel.back-left { left: 20px; }
        .wheel.back-right { right: 20px; }

        .starship-wings {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .wing {
            position: absolute;
            width: 25px;
            height: 40px;
            background: linear-gradient(45deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 1px solid #ffff00;
            box-shadow: 0 0 10px rgba(255, 255, 0, 0.4);
        }

        .wing.left {
            left: -20px;
            top: 30%;
            border-radius: 15px 0 0 15px;
            transform: skew(0deg, -10deg);
        }

        .wing.right {
            right: -20px;
            top: 30%;
            border-radius: 0 15px 15px 0;
            transform: skew(0deg, 10deg);
        }

        .starship-core {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #ffff00 0%, #cccc00 100%);
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 255, 0, 1);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 0 15px var(--theme-color);
                transform: translateX(-50%) scale(1);
            }
            50% { 
                box-shadow: 0 0 25px var(--theme-color);
                transform: translateX(-50%) scale(1.2);
            }
        }

        .particle {
            width: 40px;
            height: 40px;
            position: absolute;
            border-radius: 45% 55% 60% 40% / 50% 65% 35% 50%;
            background: radial-gradient(ellipse at 25% 25%, #8b7355 0%, #654321 30%, #3e2723 70%, #1c0e0a 100%);
            border: 1px solid #4a2c17;
            box-shadow: 
                0 0 8px rgba(139, 115, 85, 0.4),
                inset -8px -8px 15px rgba(0, 0, 0, 0.6),
                inset 4px 4px 8px rgba(139, 115, 85, 0.3);
            animation: asteroidRotate 3s linear infinite, asteroidFloat 2s ease-in-out infinite alternate;
            position: relative;
            pointer-events: none;
            will-change: transform, opacity;
            contain: paint;
            backface-visibility: hidden;
            transition: opacity 120ms linear;
            --py: 0px; 
            --scale: 1;
            transform: translate3d(0, var(--py), 0) scale(var(--scale));
        }

        .asteroid-type1 {
            border-radius: 45% 55% 60% 40% / 50% 65% 35% 50%;
            background: radial-gradient(ellipse at 25% 25%, #8b7355 0%, #654321 30%, #3e2723 70%, #1c0e0a 100%);
            border: 1px solid #4a2c17;
            box-shadow: 
                0 0 8px rgba(139, 115, 85, 0.4),
                inset -8px -8px 15px rgba(0, 0, 0, 0.6),
                inset 4px 4px 8px rgba(139, 115, 85, 0.3);
        }

        .asteroid-type2 {
            border-radius: 60% 40% 45% 55% / 35% 50% 65% 50%;
            background: radial-gradient(ellipse at 30% 20%, #a8a8a8 0%, #707070 25%, #404040 60%, #1a1a1a 100%);
            border: 1px solid #555;
            box-shadow: 
                0 0 12px rgba(168, 168, 168, 0.5),
                inset -6px -6px 12px rgba(0, 0, 0, 0.7),
                inset 3px 3px 6px rgba(200, 200, 200, 0.4);
        }

        .asteroid-type3 {
            border-radius: 55% 45% 50% 50% / 60% 40% 55% 45%;
            background: radial-gradient(ellipse at 35% 30%, #4a90e2 0%, #2c5aa0 35%, #1e3a5f 70%, #0d1929 100%);
            border: 1px solid #2c5aa0;
            box-shadow: 
                0 0 15px rgba(74, 144, 226, 0.6),
                inset -5px -5px 10px rgba(0, 0, 0, 0.5),
                inset 2px 2px 8px rgba(74, 144, 226, 0.3);
        }

        .asteroid-type4 {
            border-radius: 40% 60% 55% 45% / 50% 50% 40% 60%;
            background: radial-gradient(ellipse at 20% 40%, #ff6b35 0%, #d84315 30%, #8b2e1f 65%, #2d1810 100%);
            border: 1px solid #8b2e1f;
            box-shadow: 
                0 0 10px rgba(255, 107, 53, 0.7),
                inset -7px -7px 14px rgba(0, 0, 0, 0.6),
                inset 3px 3px 7px rgba(255, 107, 53, 0.4);
        }

        .asteroid-type5 {
            border-radius: 50% 30% 60% 40% / 45% 55% 30% 70%;
            background: radial-gradient(ellipse at 40% 25%, #e3f2fd 0%, #90caf9 25%, #42a5f5 60%, #1976d2 100%);
            border: 1px solid #1976d2;
            box-shadow: 
                0 0 18px rgba(227, 242, 253, 0.8),
                inset -4px -4px 8px rgba(25, 118, 210, 0.4),
                inset 2px 2px 6px rgba(255, 255, 255, 0.6);
        }

        .particle::before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #5d4037 0%, #3e2723 100%);
            border-radius: 60% 40% 70% 30%;
            top: 20%;
            left: 15%;
            box-shadow: 
                12px 8px 0 -2px rgba(78, 52, 46, 0.8),
                -4px 15px 0 -3px rgba(93, 64, 55, 0.6),
                20px 20px 0 -4px rgba(62, 39, 35, 0.7);
        }

        .asteroid-type2::before {
            background: radial-gradient(circle, #888 0%, #444 100%);
            box-shadow: 
                10px 6px 0 -2px rgba(136, 136, 136, 0.6),
                -3px 12px 0 -3px rgba(102, 102, 102, 0.5),
                18px 18px 0 -4px rgba(68, 68, 68, 0.7);
        }

        .asteroid-type3::before {
            background: radial-gradient(circle, #6bb6ff 0%, #2c5aa0 100%);
            box-shadow: 
                8px 10px 0 -2px rgba(107, 182, 255, 0.7),
                -5px 8px 0 -3px rgba(74, 144, 226, 0.6),
                15px 15px 0 -4px rgba(44, 90, 160, 0.8);
        }

        .asteroid-type4::before {
            background: radial-gradient(circle, #ff8a65 0%, #d84315 100%);
            box-shadow: 
                9px 7px 0 -2px rgba(255, 138, 101, 0.8),
                -4px 14px 0 -3px rgba(255, 107, 53, 0.7),
                16px 16px 0 -4px rgba(216, 67, 21, 0.8);
        }

        .asteroid-type5::before {
            background: radial-gradient(circle, #ffffff 0%, #90caf9 100%);
            box-shadow: 
                6px 8px 0 -2px rgba(255, 255, 255, 0.9),
                -3px 10px 0 -3px rgba(144, 202, 249, 0.8),
                12px 12px 0 -4px rgba(66, 165, 245, 0.7);
        }

        .particle::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #4a2c17 0%, #2d1810 100%);
            border-radius: 50% 30% 60% 40%;
            top: 60%;
            right: 20%;
            box-shadow: 
                -8px -5px 0 -1px rgba(45, 24, 16, 0.8),
                6px -10px 0 -2px rgba(74, 44, 23, 0.6);
        }

        .asteroid-type2::after {
            background: radial-gradient(circle, #666 0%, #333 100%);
            box-shadow: 
                -6px -4px 0 -1px rgba(102, 102, 102, 0.7),
                5px -8px 0 -2px rgba(85, 85, 85, 0.6);
        }

        .asteroid-type3::after {
            background: radial-gradient(circle, #5dade2 0%, #2c5aa0 100%);
            box-shadow: 
                -7px -6px 0 -1px rgba(93, 173, 226, 0.8),
                4px -9px 0 -2px rgba(44, 90, 160, 0.7);
        }

        .asteroid-type4::after {
            background: radial-gradient(circle, #ff7043 0%, #8b2e1f 100%);
            box-shadow: 
                -9px -4px 0 -1px rgba(255, 112, 67, 0.8),
                7px -11px 0 -2px rgba(139, 46, 31, 0.7);
        }

        .asteroid-type5::after {
            background: radial-gradient(circle, #e1f5fe 0%, #42a5f5 100%);
            box-shadow: 
                -5px -3px 0 -1px rgba(225, 245, 254, 0.9),
                4px -7px 0 -2px rgba(66, 165, 245, 0.8);
        }

        @keyframes asteroidRotate {
            0% { transform: translate3d(0, var(--py), 0) rotate(0deg) scale(var(--scale)); }
            25% { transform: translate3d(0, var(--py), 0) rotate(90deg) scale(calc(var(--scale) * 1.05)); }
            50% { transform: translate3d(0, var(--py), 0) rotate(180deg) scale(calc(var(--scale) * 0.95)); }
            75% { transform: translate3d(0, var(--py), 0) rotate(270deg) scale(calc(var(--scale) * 1.02)); }
            100% { transform: translate3d(0, var(--py), 0) rotate(360deg) scale(var(--scale)); }
        }

        @keyframes asteroidFloat {
            0% { 
                box-shadow: 
                    0 0 8px rgba(139, 115, 85, 0.4),
                    inset -8px -8px 15px rgba(0, 0, 0, 0.6),
                    inset 4px 4px 8px rgba(139, 115, 85, 0.3);
            }
            100% { 
                box-shadow: 
                    0 0 12px rgba(139, 115, 85, 0.6),
                    inset -6px -6px 12px rgba(0, 0, 0, 0.8),
                    inset 6px 6px 10px rgba(139, 115, 85, 0.4);
            }
        }

        .score {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #00ffff;
            font-size: 32px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.8), 
                0 0 15px rgba(0,255,255,0.8),
                0 0 25px rgba(0,255,255,0.6);
            z-index: 20;
            transition: all 0.3s ease;
        }

        .best-score {
            position: absolute;
            top: 70px;
            left: 20px;
            color: #ffff00;
            font-size: 24px;
            font-weight: 600;
            font-family: 'Orbitron', monospace;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.8), 
                0 0 15px rgba(255,255,0,0.8),
                0 0 25px rgba(255,255,0,0.6);
            z-index: 20;
            transition: all 0.3s ease;
        }

        #score {
            display: inline-block;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .score-increase {
            animation: scoreBoost 0.6s ease-out;
        }

        @keyframes scoreBoost {
            0% {
                transform: scale(1);
                color: #00ffff;
                text-shadow: 
                    2px 2px 4px rgba(0,0,0,0.8), 
                    0 0 15px rgba(0,255,255,0.8),
                    0 0 25px rgba(0,255,255,0.6);
            }
            25% {
                transform: scale(1.2);
                color: #ffff00;
                text-shadow: 
                    2px 2px 4px rgba(0,0,0,0.8), 
                    0 0 20px rgba(255,255,0,1),
                    0 0 30px rgba(255,255,0,0.8),
                    0 0 40px rgba(255,255,0,0.6);
            }
            100% {
                transform: scale(1);
                color: #00ffff;
                text-shadow: 
                    2px 2px 4px rgba(0,0,0,0.8), 
                    0 0 15px rgba(0,255,255,0.8),
                    0 0 25px rgba(0,255,255,0.6);
            }
        }

        @keyframes celebrationPulse {
            0% { 
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        .lives {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #ffff00;
            font-size: 28px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 10px rgba(255,255,0,0.5);
            z-index: 20;
            letter-spacing: 2px;
            display: flex;
            gap: 10px;
        }

        .heart {
            width: 32px;
            height: 32px;
            position: relative;
            font-size: 28px;
            color: #ff6b6b;
            text-shadow: 
                0 0 10px rgba(255, 107, 107, 0.8),
                0 0 20px rgba(255, 107, 107, 0.6),
                0 0 30px rgba(255, 107, 107, 0.4);
            animation: heartPulse 1.5s ease-in-out infinite;
            transition: all 0.3s ease;
        }

        .heart::before {
            content: '♥';
            display: block;
            width: 100%;
            height: 100%;
            text-align: center;
            line-height: 32px;
        }

        .heart.lost {
            color: #444;
            text-shadow: 
                0 0 5px rgba(68, 68, 68, 0.3);
            animation: none;
            opacity: 0.3;
        }

        @keyframes heartPulse {
            0%, 100% {
                transform: scale(1);
                text-shadow: 
                    0 0 10px rgba(255, 107, 107, 0.8),
                    0 0 20px rgba(255, 107, 107, 0.6),
                    0 0 30px rgba(255, 107, 107, 0.4);
            }
            50% {
                transform: scale(1.15);
                text-shadow: 
                    0 0 15px rgba(255, 107, 107, 1),
                    0 0 25px rgba(255, 107, 107, 0.8),
                    0 0 35px rgba(255, 107, 107, 0.6);
            }
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: #ffff00;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,0,0.3);
            border: 2px solid #ffff00;
            z-index: 30;
            font-family: 'Orbitron', monospace;
        }

        .game-over h2 {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 20px;
            letter-spacing: 4px;
            text-transform: uppercase;
        }

        .game-over p {
            font-size: 18px;
            font-weight: 400;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .restart-btn {
            background: #ffff00;
            color: #000000;
            border: 2px solid #cccc00;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255,255,0,0.5);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .restart-btn:hover {
            background: #cccc00;
            box-shadow: 0 0 15px rgba(255,255,0,0.8);
            transform: scale(1.05);
        }

        .pause-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: #ffff00;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,0,0.3);
            border: 2px solid #ffff00;
            z-index: 35;
            font-family: 'Orbitron', monospace;
            backdrop-filter: blur(10px);
        }

        .pause-menu h2 {
            font-size: 36px;
            font-weight: 900;
            margin-bottom: 30px;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 15px rgba(255,255,0,0.8);
        }

        .pause-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .pause-btn {
            background: #ffff00;
            color: #000000;
            border: 2px solid #cccc00;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Orbitron', monospace;
            border-radius: 25px;
            cursor: pointer;
            margin: 5px 0;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(255,255,0,0.5);
            letter-spacing: 2px;
            text-transform: uppercase;
            min-width: 150px;
        }

        .pause-btn:hover {
            background: #cccc00;
            box-shadow: 0 0 15px rgba(255,255,0,0.8);
            transform: scale(1.05);
        }

        .resume-btn {
            background: #00ff00;
            border-color: #00cc00;
            box-shadow: 0 0 10px rgba(0,255,0,0.5);
        }

        .resume-btn:hover {
            background: #00cc00;
            box-shadow: 0 0 15px rgba(0,255,0,0.8);
        }

        .quit-btn {
            background: #ff4444;
            border-color: #cc0000;
            box-shadow: 0 0 10px rgba(255,68,68,0.5);
        }

        .quit-btn:hover {
            background: #cc0000;
            box-shadow: 0 0 15px rgba(255,68,68,0.8);
        }

        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffff00;
            font-size: 16px;
            font-family: 'Exo 2', sans-serif;
            font-weight: 300;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8), 0 0 8px rgba(255,255,0,0.4);
            z-index: 20;
            letter-spacing: 1px;
        }

        .lane {
            position: absolute;
            width: 25vw;
            height: 100%;
            border-right: 2px dashed rgba(0, 255, 255, 0.3);
        }

        .lane:nth-child(1) { left: 0; }
        .lane:nth-child(2) { left: 25vw; }
        .lane:nth-child(3) { left: 50vw; }
        .lane:nth-child(4) { left: 75vw; border-right: none; }

        .mobile-controls {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            z-index: 25;
            gap: 60px;
            align-items: center;
        }
        
        .pause-btn-mobile {
            position: absolute;
            top: 20px;
            right: -100px;
            z-index: 26;
        }
        
        .mobile-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 0, 0.2);
            border: 3px solid rgba(255, 255, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #ffff00;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.8);
            user-select: none;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
            font-family: 'Orbitron', monospace;
            font-weight: bold;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .mobile-btn:active {
            background: rgba(255, 255, 0, 0.4);
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.6);
        }
        
        .pause-btn-mobile {
            background: rgba(255, 255, 0, 0.2);
            border: 3px solid rgba(255, 255, 0, 0.8);
            color: #ffff00;
        }
        
        .pause-btn-mobile:active {
            background: rgba(255, 255, 0, 0.4);
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.6);
        }
        
        @media (max-width: 768px) {
            .mobile-controls {
                display: flex;
            }
            
            .pause-btn-mobile {
                display: flex;
            }
            
            .instructions {
                display: none;
            }
            
            .score {
                font-size: 24px;
                top: 15px;
                left: 15px;
            }
            
            .best-score {
                font-size: 18px;
                top: 50px;
                left: 15px;
            }
            
            .lives {
                font-size: 20px;
                top: 15px;
                right: 15px;
            }
            
            .heart {
                width: 24px;
                height: 24px;
                font-size: 20px;
            }
            
            .heart::before {
                line-height: 24px;
            }
            
            .car {
                width: 50px;
                height: 100px;
                bottom: 120px;
            }
            
            .particle {
                width: 35px;
                height: 35px;
            }
            
            .game-over {
                padding: 30px;
                max-width: 90vw;
            }
            
            .game-over h2 {
                font-size: 28px;
                margin-bottom: 15px;
            }
            
            .game-over p {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .restart-btn {
                padding: 12px 25px;
                font-size: 16px;
            }
            
            .pause-menu {
                padding: 30px;
                max-width: 90vw;
            }
            
            .pause-menu h2 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .pause-btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 120px;
            }
        }
        
        @media (max-width: 480px) {
            .score {
                font-size: 20px;
            }
            
            .best-score {
                font-size: 16px;
                top: 45px;
                left: 15px;
            }
            
            .lives {
                font-size: 18px;
            }
            
            .heart {
                width: 20px;
                height: 20px;
                font-size: 18px;
            }
            
            .heart::before {
                line-height: 20px;
            }
            
            .car {
                width: 45px;
                height: 90px;
            }
            
            .particle {
                width: 30px;
                height: 30px;
            }
            
            .mobile-btn {
                width: 70px;
                height: 70px;
                font-size: 28px;
            }
            
            .pause-btn-mobile {
                width: 60px;
                height: 60px;
                font-size: 24px;
                top: 15px;
                right: -80px;
            }
            
            .game-over h2 {
                font-size: 24px;
            }
        }

        .music-control {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 50;
            font-family: 'Orbitron', monospace;
        }

        .music-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 0, 0.2);
            border: 3px solid rgba(255, 255, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #ffff00;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.8);
            user-select: none;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.3);
        }

        .music-btn:hover {
            background: rgba(255, 255, 0, 0.4);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.6);
        }

        .music-btn:active {
            transform: scale(0.95);
        }

        .music-btn.muted {
            background: rgba(255, 0, 0, 0.2);
            border-color: rgba(255, 0, 0, 0.8);
            color: #ff4444;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.8);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }

        .music-btn.muted:hover {
            background: rgba(255, 0, 0, 0.4);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
        }

        @media (max-width: 768px) {
            .music-control {
                top: 15px;
                right: 15px;
            }
            
            .music-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        @keyframes themeWave {
            0% {
                transform: scale(0.1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.6;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        @keyframes themeBurst {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            70% {
                transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: translate(calc(-50% + var(--dx) * 1.5), calc(-50% + var(--dy) * 1.5)) scale(0);
                opacity: 0;
            }
        }

        @keyframes trailFade {
            0% {
                opacity: 0.8;
                transform: scale(1);
            }
            50% {
                opacity: 0.4;
                transform: scale(1.2);
            }
            100% {
                opacity: 0;
                transform: scale(0.3);
            }
        }

        @keyframes burstParticle {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            70% {
                opacity: 0.6;
                transform: translate(0, 0) scale(1.3);
            }
            100% {
                opacity: 0;
                transform: translate(0, 0) scale(0.2);
            }
        }

        .ai-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: none;
            z-index: 50;
            font-family: 'Orbitron', monospace;
        }

        @media (min-width: 769px) {
            .ai-assistant {
                display: block;
            }
        }

        .captain-figure {
            font-size: 50px;
            text-align: center;
            animation: captainFloat 3s ease-in-out infinite, captainGlow 2s ease-in-out infinite alternate;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .captain-figure:hover {
            transform: scale(1.1);
        }

        @keyframes captainFloat {
            0%, 100% { 
                transform: translateY(0);
            }
            50% { 
                transform: translateY(-5px);
            }
        }

        @keyframes captainGlow {
            0% {
                filter: drop-shadow(0 0 5px rgba(255, 255, 0, 0.3));
            }
            100% {
                filter: drop-shadow(0 0 15px rgba(255, 255, 0, 0.8));
            }
        }

        .speech-bubble {
            background: rgba(0,0,0,0.9);
            color: #ffff00;
            padding: 12px;
            border-radius: 15px;
            position: relative;
            margin-top: 10px;
            max-width: 220px;
            font-size: 13px;
            line-height: 1.3;
            opacity: 0;
            transform: scale(0.8) translateY(10px) rotate(-2deg);
            transition: opacity 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55), transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 0 20px rgba(255,255,0,0.5), inset 0 0 10px rgba(255,255,0,0.1);
            animation: bubblePulse 2s ease-in-out infinite;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            right: 30px;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 15px solid rgba(0,0,0,0.9);
            animation: arrowBounce 1.5s ease-in-out infinite;
        }

        .speech-bubble.show {
            opacity: 1;
            transform: scale(1) translateY(0) rotate(0deg);
            animation: bubbleShow 0.8s ease-out, bubbleWiggle 2s ease-in-out infinite 1s;
        }

        @keyframes bubblePulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255,255,0,0.5), inset 0 0 10px rgba(255,255,0,0.1);
            }
            50% {
                box-shadow: 0 0 25px rgba(255,255,0,0.7), inset 0 0 15px rgba(255,255,0,0.2);
            }
        }

        @keyframes bubbleShow {
            0% {
                opacity: 0;
                transform: scale(0.5) translateY(20px) rotate(10deg);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1) translateY(-5px) rotate(-2deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0) rotate(0deg);
            }
        }

        @keyframes bubbleWiggle {
            0%, 100% {
                transform: scale(1) translateY(0) rotate(0deg);
            }
            25% {
                transform: scale(1.02) translateY(-1px) rotate(1deg);
            }
            75% {
                transform: scale(0.98) translateY(1px) rotate(-1deg);
            }
        }

        @keyframes arrowBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-2px);
            }
        }

        body {
            transition: background 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        body::before, body::after {
            transition: background-image 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .road {
            transition: background-image 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .lane {
            transition: border-color 1s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-stars"></div>
        <div class="loading-title">Rock Runner</div>
        <div class="loading-text" id="loadingText">Initializing Systems...</div>
        <div class="loading-bar-container">
            <div class="loading-bar" id="loadingBar"></div>
        </div>
        <div class="control-message" id="controlMessage" style="display: none;">
            Take Over Control
        </div>
        <div class="start-prompt" id="startPrompt" style="display: none;">
            Click anywhere or press any key to begin
        </div>
    </div>

    <div class="game-container">
        <div class="road"></div>
        <div class="lane-lines"></div>
        
        <div class="score">Score: <span id="score">0</span></div>
        <div class="best-score">Best: <span id="bestScoreDisplay">0</span></div>
        <div class="lives" id="livesContainer">
            <div class="heart" id="heart1"></div>
            <div class="heart" id="heart2"></div>
            <div class="heart" id="heart3"></div>
        </div>
        
        <div class="car" id="car">
            <div class="starship-wings">
                <div class="wing left"></div>
                <div class="wing right"></div>
            </div>
            <div class="car-body">
                <div class="starship-core"></div>
                <div class="car-windshield"></div>
            </div>
            <div class="car-wheels">
                <div class="wheel front-left"></div>
                <div class="wheel front-right"></div>
                <div class="wheel back-left"></div>
                <div class="wheel back-right"></div>
            </div>
        </div>
        
        <div class="game-over" id="gameOver">
            <h2>Game Over!</h2>
            <p>Final Score: <span id="finalScore">0</span></p>
            <p>Best Score: <span id="bestScore">0</span></p>
            <p id="newRecordMessage" style="display: none; color: #00ff00; font-weight: bold; font-size: 20px; margin: 10px 0;">🏆 NEW RECORD! 🏆</p>
            <button class="restart-btn" onclick="restartGame()">Drive Again</button>
            <button class="restart-btn" onclick="returnToHome()" style="margin-top: 10px; background: rgba(255, 255, 0, 0.2); color: #ffff00; border: 2px solid rgba(255, 255, 0, 0.6);">Return to Home</button>
        </div>
        
        <div class="pause-menu" id="pauseMenu">
            <h2>Game Paused</h2>
            <div class="pause-options">
                <button class="pause-btn resume-btn" onclick="resumeGame()">Resume</button>
                <button class="pause-btn restart-btn" onclick="restartGame()">Restart</button>
                <button class="pause-btn" onclick="returnToHome()" style="background: rgba(255, 255, 0, 0.2); color: #ffff00; border: 2px solid rgba(255, 255, 0, 0.6);">Home</button>
                <button class="pause-btn quit-btn" onclick="quitGame()">Quit</button>
            </div>
        </div>
        
        <div class="ai-assistant" id="aiAssistant">
            <div class="captain-figure">🧑‍🚀</div>
            <div class="speech-bubble" id="speechBubble">
                <p id="aiMessage">Welcome, Captain!</p>
            </div>
        </div>
        
        <div class="instructions">
            Use ← → arrow keys or A/D to change lanes • Press P or Space to pause • Avoid the particles!
        </div>
        
        <div class="mobile-controls">
            <div class="mobile-btn" id="leftBtn">←</div>
            <div class="mobile-btn" id="rightBtn">→</div>
        </div>
        
        <div class="mobile-btn pause-btn-mobile" id="pauseBtn">⏸️</div>
    </div>

    <audio id="backgroundMusic" loop>
        <source src="music.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <audio id="lifeSound">
        <source src="life.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

        <div class="music-control">
            <button id="muteButton" class="music-btn" onclick="toggleMusic()">🔊</button>
        </div>

    <script>
    const urlParams = new URLSearchParams(window.location.search);
    let gameSettings = {
        musicVolume: 50,
        sfxVolume: 70,
        difficulty: 2,
        particleEffects: true,
        screenShake: true,
        aiAssistant: true
    };
    let currentUser = null;
    let authToken = null;

    const API_BASE_URL = 'http://localhost:8371/api';

    if (urlParams.has('settings')) {
        try {
            gameSettings = JSON.parse(atob(urlParams.get('settings')));
        } catch (e) {
            console.log('Could not parse settings from URL');
        }
    }

    if (urlParams.has('user')) {
        try {
            currentUser = JSON.parse(atob(urlParams.get('user')));
        } catch (e) {
            console.log('Could not parse user from URL');
        }
    }

    if (urlParams.has('token')) {
        try {
            authToken = urlParams.get('token');
        } catch (e) {
            console.log('Could not parse token from URL');
        }
    }

    async function apiCall(endpoint, options = {}) {
        const config = {
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };

        if (authToken) {
            config.headers['Authorization'] = `Bearer ${authToken}`;
        }
        
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
            const data = await response.json();
            return { response, data };
        } catch (error) {
            console.error('API call failed:', error);
            return { response: null, data: { success: false, message: 'Network error' } };
        }
    }

    async function updateGameStats(finalScore, gameTime, difficulty) {
        if (!authToken || !currentUser) {
            console.warn('No auth token or user available for stats update');
            return false;
        }
        
        try {
            const { data } = await apiCall('/user/update-score', {
                method: 'POST',
                body: JSON.stringify({
                    score: finalScore,
                    playtime: Math.floor(gameTime / 1000), // Convert to seconds
                    difficulty: difficulty
                })
            });
            
            if (data.success) {
                console.log('Stats updated successfully');
                if (data.newHighScore) {
                    showHighScoreEffect();
                }
                return true;
            } else {
                console.error('Stats update failed:', data.message);
                return false;
            }
        } catch (error) {
            console.error('Stats update error:', error);
            return false;
        }
    }

    function showHighScoreEffect() {
        const celebration = document.createElement('div');
        celebration.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ffd700;
            font-family: 'Orbitron', monospace;
            font-size: 36px;
            font-weight: 900;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            z-index: 10000;
            animation: celebrationPulse 2s ease-in-out;
        `;
        celebration.textContent = '🏆 NEW HIGH SCORE! 🏆';
        document.body.appendChild(celebration);
        
        setTimeout(() => {
            if (celebration.parentNode) {
                celebration.parentNode.removeChild(celebration);
            }
        }, 2000);
    }

    function returnToHome() {
        if (currentUser && authToken) {
            const sessionTime = Date.now() - (gameState.startTime || Date.now());
            updateGameStats(gameState.score, sessionTime, gameSettings.difficulty);
        }
        
        window.location.href = 'home.html';
    }

    const loadingScreen = document.getElementById('loadingScreen');
    const loadingBar = document.getElementById('loadingBar');
    const controlMessage = document.getElementById('controlMessage');
    const startPrompt = document.getElementById('startPrompt');
    
    let loadingProgress = 0;
    let gameInitialized = false;
    let waitingForInput = false;

    function updateLoadingBar() {
        loadingBar.style.width = loadingProgress + '%';
    }

    function simulateLoading() {
        const loadingInterval = setInterval(() => {
            loadingProgress += Math.random() * 8 + 2;
            
            if (loadingProgress >= 100) {
                loadingProgress = 100;
                clearInterval(loadingInterval);
                showControlMessage();
            }
            
            updateLoadingBar();
        }, 150 + Math.random() * 100);
    }

    function showControlMessage() {
        setTimeout(() => {
            controlMessage.style.display = 'block';
            
            setTimeout(() => {
                startPrompt.style.display = 'block';
                waitingForInput = true;
                setupInputListeners();
            }, 1500);
        }, 500);
    }

    function setupInputListeners() {
        const handleUserInput = () => {
            if (waitingForInput) {
                waitingForInput = false;
                removeInputListeners();
                startGame();
            }
        };

        document.addEventListener('click', handleUserInput);
        document.addEventListener('keydown', handleUserInput);
        document.addEventListener('touchstart', handleUserInput);

        window.loadingInputHandler = handleUserInput;
    }

    function removeInputListeners() {
        if (window.loadingInputHandler) {
            document.removeEventListener('click', window.loadingInputHandler);
            document.removeEventListener('keydown', window.loadingInputHandler);
            document.removeEventListener('touchstart', window.loadingInputHandler);
            window.loadingInputHandler = null;
        }
    }

    function startGame() {
        loadingScreen.classList.add('hidden');
        
        setTimeout(() => {
            if (!gameInitialized) {
                initializeGame();
                gameInitialized = true;
            }
        }, 1000);
    }

    function initializeGame() {
        backgroundMusic.play().catch(e => console.log('Could not auto-play music:', e));
        
        gameLoop();
        
        startAIAssistant();
    }

    window.addEventListener('load', () => {
        if (currentUser) {
            const displayName = currentUser.callsign ? `${currentUser.username} "${currentUser.callsign}"` : currentUser.username;
            document.getElementById('loadingText').textContent = `Welcome, Captain ${displayName}`;
        }
        
        setTimeout(() => {
            simulateLoading();
        }, 500);
    });

    const gameContainer = document.querySelector('.game-container');
    const car = document.getElementById('car');
    const scoreElement = document.getElementById('score');
    const bestScoreDisplayElement = document.getElementById('bestScoreDisplay');
    const livesContainer = document.getElementById('livesContainer');
    const gameOverElement = document.getElementById('gameOver');
    const pauseMenuElement = document.getElementById('pauseMenu');
    const finalScoreElement = document.getElementById('finalScore');
    const bestScoreElement = document.getElementById('bestScore');
    const newRecordMessageElement = document.getElementById('newRecordMessage');
    const road = document.querySelector('.road');

    function loadBestScore() {
        const saved = localStorage.getItem('rockRunnerBestScore');
        return saved ? parseInt(saved) : 0;
    }

    function saveBestScore(score) {
        localStorage.setItem('rockRunnerBestScore', score.toString());
    }

    let bestScore = loadBestScore();
    if (bestScoreDisplayElement) {
        bestScoreDisplayElement.textContent = bestScore;
    }

        let gameState = {
            currentLane: 1,
            targetLane: 1,
            currentPosition: 0,
            targetPosition: 0,
            velocity: 0,
            acceleration: 0,
            maxSpeed: 8,
            friction: 0.85,
            turnForce: 0.6,
            score: 0,
            lives: 3,
            particles: [],
            gameRunning: true,
            isPaused: false,
            startTime: Date.now(),
            particleSpeed: 6,
            baseSpawnRate: 0.015,
            spawnRate: 0.015,
            spawnAttempts: 1,
            particleCap: 60,
            gameSpeed: 1,
            isTransitioning: false,
            lastTurnTime: 0,
            lastScoreTime: Date.now(),
            themeColor: '#ffff00',
            rotationVelocity: 0,
            currentRotation: 0,
            lastMoveDirection: 0,
            boostTime: 0,
            trailParticles: []
        };

    const lanePositions = [window.innerWidth * 0.125, window.innerWidth * 0.375, window.innerWidth * 0.625, window.innerWidth * 0.875];
        let keys = {};

        recomputeLanes();

        document.addEventListener('keydown', (e) => {
            if (!keys[e.key]) {
                keys[e.key] = true;
                handleInput(e.key);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'p' || e.key === 'P' || e.key === 'Escape' || e.key === ' ') {
                e.preventDefault();
                if (gameState.gameRunning && !gameState.isPaused) {
                    pauseGame();
                } else if (gameState.isPaused) {
                    resumeGame();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        let touchStartX = 0;
        let touchStartY = 0;
        let isSwiping = false;

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = true;
            }
        });

        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchend', (e) => {
            if (!isSwiping) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                if (deltaX > 0) {
                    handleInput('ArrowRight');
                } else {
                    handleInput('ArrowLeft');
                }
            }
            
            isSwiping = false;
        });

        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const pauseBtn = document.getElementById('pauseBtn');

        if (leftBtn) {
            leftBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleInput('ArrowLeft');
            });
            
            leftBtn.addEventListener('click', (e) => {
                e.preventDefault();
                handleInput('ArrowLeft');
            });
        }

        if (rightBtn) {
            rightBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleInput('ArrowRight');
            });
            
            rightBtn.addEventListener('click', (e) => {
                e.preventDefault();
                handleInput('ArrowRight');
            });
        }

        if (pauseBtn) {
            pauseBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState.gameRunning && !gameState.isPaused) {
                    pauseGame();
                } else if (gameState.isPaused) {
                    resumeGame();
                }
            });
            
            pauseBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (gameState.gameRunning && !gameState.isPaused) {
                    pauseGame();
                } else if (gameState.isPaused) {
                    resumeGame();
                }
            });
        }

        function handleInput(key) {
            if (!gameState.gameRunning || gameState.isPaused) return;
            
            const currentTime = Date.now();
            
            if (currentTime - gameState.lastTurnTime < 150) return;

            if ((key === 'ArrowLeft' || key === 'a' || key === 'A') && gameState.targetLane > 0) {
                gameState.targetLane--;
                initiateTurn('left');
                gameState.lastTurnTime = currentTime;
            }
            if ((key === 'ArrowRight' || key === 'd' || key === 'D') && gameState.targetLane < 3) {
                gameState.targetLane++;
                initiateTurn('right');
                gameState.lastTurnTime = currentTime;
            }
        }

        function initiateTurn(direction) {
            gameState.isTransitioning = true;
            gameState.targetPosition = lanePositions[gameState.targetLane];
            gameState.lastMoveDirection = direction === 'left' ? -1 : 1;
            gameState.boostTime = Date.now();

            const thrusters = document.querySelectorAll('.wheel');
            thrusters.forEach(thruster => {
                thruster.style.animation = 'thrusterBoost 0.4s ease-out';
                thruster.style.transform = `scaleY(1.3) ${direction === 'left' ? 'skewX(-2deg)' : 'skewX(2deg)'}`;
            });

            setTimeout(() => {
                thrusters.forEach(thruster => {
                    thruster.style.animation = 'thruster 0.1s infinite alternate';
                    thruster.style.transform = 'scaleY(1) skewX(0deg)';
                });
            }, 400);
            
            createMovementTrail(direction);
            
            createScreenShake();
        }

        function createMovementTrail(direction) {
            const trailCount = 5;
            const car = document.getElementById('car');
            const carRect = car.getBoundingClientRect();
            
            for (let i = 0; i < trailCount; i++) {
                setTimeout(() => {
                    const trail = document.createElement('div');
                    trail.style.cssText = `
                        position: absolute;
                        width: 40px;
                        height: 40px;
                        left: ${gameState.currentPosition - 20}px;
                        top: ${carRect.top + window.scrollY + 40}px;
                        background: radial-gradient(circle, ${gameState.themeColor}40 0%, transparent 70%);
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 5;
                        animation: trailFade 0.8s ease-out forwards;
                    `;
                    
                    gameContainer.appendChild(trail);
                    gameState.trailParticles.push(trail);
                    
                    setTimeout(() => {
                        if (trail.parentNode) {
                            trail.remove();
                        }
                        gameState.trailParticles = gameState.trailParticles.filter(p => p !== trail);
                    }, 800);
                }, i * 50);
            }
        }

        function createScreenShake() {
            if (!gameSettings.screenShake) return;
            
            const intensity = 3;
            const duration = 150;
            
            const originalTransform = gameContainer.style.transform || '';
            
            let startTime = Date.now();
            function shake() {
                const elapsed = Date.now() - startTime;
                if (elapsed > duration) {
                    gameContainer.style.transform = originalTransform;
                    return;
                }
                
                const progress = elapsed / duration;
                const currentIntensity = intensity * (1 - progress);
                
                const x = (Math.random() - 0.5) * currentIntensity;
                const y = (Math.random() - 0.5) * currentIntensity;
                
                gameContainer.style.transform = `${originalTransform} translate(${x}px, ${y}px)`;
                
                requestAnimationFrame(shake);
            }
            
            shake();
        }

        function updateScore() {
            const currentTime = Date.now();
            if (currentTime - gameState.lastScoreTime >= 1000) {
                const targetScore = gameState.score + 3;
                animateScoreCount(gameState.score, targetScore);
                gameState.score = targetScore;
                gameState.lastScoreTime = currentTime;
                
                if (gameState.score % 30 === 0 && gameState.score > 0) {
                    changeThemeColor();
                    gameState.particleSpeed = Math.min(12, gameState.particleSpeed + 0.2);
                    gameState.baseSpawnRate = Math.min(0.05, gameState.baseSpawnRate + 0.003);
                    applySpawnSettings();
                }
            }
        }
        function animateScoreCount(fromScore, toScore) {
            const duration = 600;
            const steps = toScore - fromScore;
            const stepDuration = duration / steps;
            
            let currentScore = fromScore;
            
            const countUp = () => {
                if (currentScore < toScore) {
                    currentScore++;
                    scoreElement.textContent = currentScore;
                    
                    setTimeout(countUp, stepDuration);
                } else {
                    scoreElement.classList.remove('score-increase');
                    void scoreElement.offsetWidth;
                    scoreElement.classList.add('score-increase');
                }
            };
            
            countUp();
        }

        function generateRandomColor() {
            const colors = [
                '#ff6b6b',
                '#4ecdc4',
                '#45b7d1',
                '#96ceb4',
                '#ffeaa7',
                '#dda0dd',
                '#98d8c8',
                '#f7dc6f',
                '#bb8fce',
                '#85c1e9',
                '#f8c471',
                '#82e0aa',
                '#f1948a',
                '#85c1e9'
            ];
            
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function changeThemeColor() {
            const newColor = generateRandomColor();
            gameState.themeColor = newColor;
            createThemeChangeEffect(newColor);
            
            const scoreContainer = document.querySelector('.score');
            if (scoreContainer) {
                scoreContainer.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                scoreContainer.style.setProperty('color', newColor, 'important');
                scoreContainer.style.setProperty('text-shadow', `2px 2px 4px rgba(0,0,0,0.8), 0 0 15px ${newColor}, 0 0 25px ${newColor}`, 'important');
            }
            scoreElement.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            scoreElement.style.setProperty('color', newColor, 'important');
            scoreElement.style.setProperty('text-shadow', `2px 2px 4px rgba(0,0,0,0.8), 0 0 15px ${newColor}, 0 0 25px ${newColor}`, 'important');
            
            if (bestScoreDisplayElement) {
                bestScoreDisplayElement.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                bestScoreDisplayElement.style.setProperty('color', newColor, 'important');
                bestScoreDisplayElement.style.setProperty('text-shadow', `2px 2px 4px rgba(0,0,0,0.8), 0 0 15px ${newColor}, 0 0 25px ${newColor}`, 'important');
            }
            
            const bestScoreContainer = document.querySelector('.best-score');
            if (bestScoreContainer) {
                bestScoreContainer.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                bestScoreContainer.style.setProperty('color', newColor, 'important');
                bestScoreContainer.style.setProperty('text-shadow', `2px 2px 4px rgba(0,0,0,0.8), 0 0 15px ${newColor}, 0 0 25px ${newColor}`, 'important');
            }
            
            const livesElement = document.querySelector('.lives');
            const gameOverText = document.querySelector('.game-over');
            const instructions = document.querySelector('.instructions');
            
            if (instructions) {
                instructions.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                instructions.style.setProperty('color', newColor, 'important');
                instructions.style.setProperty('text-shadow', `2px 2px 4px rgba(0,0,0,0.8), 0 0 10px ${newColor}`, 'important');
            }
            
            if (gameOverText) {
                const gameOverHeading = gameOverText.querySelector('h2');
                const gameOverParagraph = gameOverText.querySelector('p');
                const restartButton = gameOverText.querySelector('button');
                
                if (gameOverHeading) {
                    gameOverHeading.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    gameOverHeading.style.setProperty('color', newColor, 'important');
                    gameOverHeading.style.setProperty('text-shadow', `2px 2px 4px rgba(0,0,0,0.8), 0 0 15px ${newColor}`, 'important');
                }
                if (gameOverParagraph) {
                    gameOverParagraph.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    gameOverParagraph.style.setProperty('color', newColor, 'important');
                }
                if (restartButton) {
                    restartButton.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    restartButton.style.setProperty('background', `linear-gradient(45deg, ${newColor}, #333)`, 'important');
                    restartButton.style.setProperty('border', `2px solid ${newColor}`, 'important');
                    restartButton.style.setProperty('box-shadow', `0 0 10px ${newColor}`, 'important');
                }
                gameOverText.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                gameOverText.style.setProperty('border-color', newColor, 'important');
                gameOverText.style.setProperty('box-shadow', `0 10px 30px rgba(0,0,0,0.8), 0 0 20px ${newColor}`, 'important');
            }
            
            const pauseMenu = document.getElementById('pauseMenu');
            if (pauseMenu) {
                const pauseMenuHeading = pauseMenu.querySelector('h2');
                const pauseButtons = pauseMenu.querySelectorAll('.pause-btn');
                
                if (pauseMenuHeading) {
                    pauseMenuHeading.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    pauseMenuHeading.style.setProperty('color', newColor, 'important');
                    pauseMenuHeading.style.setProperty('text-shadow', `2px 2px 4px rgba(0,0,0,0.8), 0 0 15px ${newColor}`, 'important');
                }
                
                pauseButtons.forEach(button => {
                    if (!button.classList.contains('resume-btn') && !button.classList.contains('quit-btn')) {
                        button.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        button.style.setProperty('background', newColor, 'important');
                        button.style.setProperty('border-color', shadeColor(newColor, -25), 'important');
                        button.style.setProperty('box-shadow', `0 0 10px ${newColor}`, 'important');
                    }
                });
                
                pauseMenu.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                pauseMenu.style.setProperty('border-color', newColor, 'important');
                pauseMenu.style.setProperty('box-shadow', `0 10px 30px rgba(0,0,0,0.8), 0 0 20px ${newColor}`, 'important');
            }
            
            const hearts = document.querySelectorAll('.heart:not(.lost)');
            hearts.forEach(heart => {
                heart.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                heart.style.setProperty('text-shadow', `
                    0 0 10px ${newColor},
                    0 0 20px ${newColor},
                    0 0 30px rgba(255, 107, 107, 0.4)
                `, 'important');
            });
            
            const starshipCore = document.querySelector('.starship-core');
            const leftWing = document.querySelector('.wing.left');
            const rightWing = document.querySelector('.wing.right');
            const thrusters = document.querySelectorAll('.wheel');
            const carBody = document.querySelector('.car-body');
            const windshield = document.querySelector('.car-windshield');
            
            if (starshipCore) {
                starshipCore.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                starshipCore.style.setProperty('background', `radial-gradient(circle, ${newColor} 0%, #333 100%)`, 'important');
                starshipCore.style.setProperty('box-shadow', `0 0 20px ${newColor}, inset -3px -3px 6px rgba(0, 0, 0, 0.6), inset 3px 3px 6px rgba(255, 255, 255, 0.2)`, 'important');
            }
            
            if (leftWing && rightWing) {
                const wingColor = `linear-gradient(45deg, ${newColor} 0%, #666 50%, #333 100%)`;
                const wingGlow = `0 0 15px ${newColor}, inset -2px -2px 4px rgba(0, 0, 0, 0.5)`;
                leftWing.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                leftWing.style.setProperty('background', wingColor, 'important');
                leftWing.style.setProperty('box-shadow', wingGlow, 'important');
                leftWing.style.setProperty('border-color', newColor, 'important');
                rightWing.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                rightWing.style.setProperty('background', wingColor, 'important');
                rightWing.style.setProperty('box-shadow', wingGlow, 'important');
                rightWing.style.setProperty('border-color', newColor, 'important');
            }
            
            if (carBody) {
                carBody.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                carBody.style.setProperty('border-color', newColor, 'important');
                carBody.style.setProperty('box-shadow', `0 0 20px ${newColor}, inset 0 0 10px rgba(255, 255, 255, 0.2)`, 'important');
            }
            if (windshield) {
                windshield.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                windshield.style.setProperty('border-color', newColor, 'important');
                windshield.style.setProperty('box-shadow', `0 0 15px ${newColor}, inset 0 0 10px rgba(255, 255, 255, 0.1)`, 'important');
                windshield.style.setProperty('background', `linear-gradient(to bottom, ${rgbaString(newColor,0.8)} 0%, ${rgbaString(newColor,0.6)} 50%, ${rgbaString(newColor,0.4)} 100%)`, 'important');
            }
            if (thrusters && thrusters.length) {
                thrusters.forEach(t => {
                    t.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                    t.style.setProperty('border-color', shadeColor(newColor, -25), 'important');
                    t.style.setProperty('box-shadow', `0 0 10px ${newColor}, inset 0 0 5px rgba(255,255,255,0.3)`, 'important');
                    t.style.setProperty('background', `linear-gradient(to bottom, ${newColor} 0%, ${shadeColor(newColor, -20)} 50%, ${newColor} 100%)`, 'important');
                });
            }
            
            scoreElement.style.transform = 'scale(1.5)';
            scoreElement.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                scoreElement.style.transform = 'scale(1)';
            }, 500);
            
            const existingStyle = document.getElementById('dynamic-score-style');
            if (existingStyle) {
                existingStyle.remove();
            }
            
            const backgroundElements = [document.body];
            backgroundElements.forEach(el => {
                if (el) {
                    el.style.transition = 'all 1s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                }
            });
            
            const style = document.createElement('style');
            style.id = 'dynamic-score-style';
            style.textContent = `
                body::before {
                    background-image: 
                        radial-gradient(1px 1px at 20px 30px, ${newColor}, transparent),
                        radial-gradient(2px 2px at 40px 70px, ${newColor}, transparent),
                        radial-gradient(1px 1px at 90px 40px, ${newColor}, transparent),
                        radial-gradient(1px 1px at 130px 80px, ${newColor}, transparent),
                        radial-gradient(2px 2px at 160px 30px, ${newColor}, transparent) !important;
                    transition: background-image 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
                }
                
                body::after {
                    background-image: 
                        radial-gradient(1px 1px at 60px 50px, ${newColor}, transparent),
                        radial-gradient(1px 1px at 100px 90px, ${newColor}, transparent),
                        radial-gradient(2px 2px at 140px 20px, ${newColor}, transparent),
                        radial-gradient(1px 1px at 180px 60px, ${newColor}, transparent),
                        radial-gradient(2px 2px at 80px 120px, ${newColor}, transparent) !important;
                    transition: background-image 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
                }
                
                .road { 
                    background-image:
                        radial-gradient(1px 1px at 10% 20%, ${newColor}, transparent),
                        radial-gradient(2px 2px at 25% 40%, ${newColor}, transparent),
                        radial-gradient(1px 1px at 40% 10%, ${newColor}, transparent),
                        radial-gradient(3px 3px at 60% 30%, ${newColor}, transparent),
                        radial-gradient(1px 1px at 75% 60%, ${newColor}, transparent),
                        radial-gradient(2px 2px at 90% 80%, ${newColor}, transparent),
                        radial-gradient(1px 1px at 15% 70%, ${newColor}, transparent),
                        radial-gradient(2px 2px at 85% 15%, ${newColor}, transparent) !important;
                    transition: background-image 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
                }
                .lane { 
                    border-right: 1px dashed ${rgbaString(newColor,0.25)} !important; 
                    transition: border-color 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
                }
                .lane:nth-child(4) { border-right: none !important; }
                
                @keyframes scoreBoost {
                    0% {
                        transform: scale(1) !important;
                        color: ${newColor} !important;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 15px ${newColor}, 0 0 25px ${newColor} !important;
                    }
                    25% {
                        transform: scale(1.3) rotate(2deg) !important;
                        color: #ffff00 !important;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 20px rgba(255,255,0,1), 0 0 30px rgba(255,255,0,0.8), 0 0 40px ${newColor} !important;
                    }
                    100% {
                        transform: scale(1) rotate(0deg) !important;
                        color: ${newColor} !important;
                        text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 15px ${newColor}, 0 0 25px ${newColor} !important;
                    }
                }
                
                #newRecordMessage {
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 20px #00ff00, 0 0 30px #00ff00 !important;
                }
                
                @keyframes captainGlow {
                    0% {
                        filter: drop-shadow(0 0 5px ${rgbaString(newColor, 0.3)});
                    }
                    100% {
                        filter: drop-shadow(0 0 15px ${newColor});
                    }
                }
                
                @keyframes bubblePulse {
                    0%, 100% {
                        box-shadow: 0 0 20px ${rgbaString(newColor, 0.5)}, inset 0 0 10px ${rgbaString(newColor, 0.1)};
                    }
                    50% {
                        box-shadow: 0 0 25px ${rgbaString(newColor, 0.7)}, inset 0 0 15px ${rgbaString(newColor, 0.2)};
                    }
                }
                
                .captain-figure {
                    animation: captainFloat 3s ease-in-out infinite, captainGlow 2s ease-in-out infinite alternate !important;
                }
                
                .speech-bubble {
                    box-shadow: 0 0 20px ${newColor}, inset 0 0 10px ${rgbaString(newColor, 0.1)} !important;
                    animation: bubblePulse 2s ease-in-out infinite !important;
                }
                
                .music-btn:not(.muted) {
                    color: ${newColor} !important;
                    border-color: ${rgbaString(newColor, 0.8)} !important;
                    text-shadow: 0 0 10px ${newColor} !important;
                    box-shadow: 0 0 15px ${rgbaString(newColor, 0.3)} !important;
                }
                
                .music-btn:not(.muted):hover {
                    background: ${rgbaString(newColor, 0.4)} !important;
                    box-shadow: 0 0 20px ${rgbaString(newColor, 0.6)} !important;
                }
            `;
            document.head.appendChild(style);
            
            document.documentElement.style.setProperty('--theme-color', newColor);
            document.documentElement.style.setProperty('--theme-color-dim', rgbaString(newColor, 0.8));
            
            const mobileButtons = document.querySelectorAll('.mobile-btn');
            mobileButtons.forEach(btn => {
                btn.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                btn.style.setProperty('color', newColor, 'important');
                btn.style.setProperty('border-color', rgbaString(newColor, 0.8), 'important');
                btn.style.setProperty('text-shadow', `0 0 10px ${newColor}`, 'important');
            });
            
            const aiAssistant = document.getElementById('aiAssistant');
            const speechBubble = document.getElementById('speechBubble');
            const aiMessage = document.getElementById('aiMessage');
            const captainFigure = document.querySelector('.captain-figure');
            
            if (speechBubble) {
                speechBubble.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                speechBubble.style.setProperty('color', newColor, 'important');
                speechBubble.style.setProperty('box-shadow', `0 0 20px ${newColor}, inset 0 0 10px ${rgbaString(newColor, 0.1)}`, 'important');
            }
            
            if (aiMessage) {
                aiMessage.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                aiMessage.style.setProperty('color', newColor, 'important');
            }
            
            if (captainFigure) {
                captainFigure.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                captainFigure.style.setProperty('filter', `drop-shadow(0 0 15px ${newColor})`, 'important');
            }
            
            const muteButton = document.getElementById('muteButton');
            if (muteButton && !muteButton.classList.contains('muted')) {
                muteButton.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                muteButton.style.setProperty('color', newColor, 'important');
                muteButton.style.setProperty('border-color', rgbaString(newColor, 0.8), 'important');
                muteButton.style.setProperty('text-shadow', `0 0 10px ${newColor}`, 'important');
                muteButton.style.setProperty('box-shadow', `0 0 15px ${rgbaString(newColor, 0.3)}`, 'important');
            }
            
            car.style.transition = 'filter 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            car.style.filter = `drop-shadow(0 0 15px ${rgbaString(gameState.themeColor, 0.35)})`;
            
            car.style.transform = 'scale(1.1)';
            setTimeout(() => {
                car.style.transform = 'scale(1)';
            }, 200);
        }

        function createThemeChangeEffect(newColor) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: radial-gradient(circle at center, ${rgbaString(newColor, 0.15)} 0%, transparent 70%);
                pointer-events: none;
                z-index: 25;
                animation: themeWave 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
                transform: scale(0.1);
            `;
            
            document.body.appendChild(overlay);
            
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                const angle = (i / 12) * Math.PI * 2;
                const distance = 150 + Math.random() * 100;
                const x = Math.cos(angle) * distance;
                const y = Math.sin(angle) * distance;
                
                particle.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    width: 8px;
                    height: 8px;
                    background: ${newColor};
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 26;
                    box-shadow: 0 0 15px ${newColor};
                    animation: themeBurst 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
                    transform: translate(-50%, -50%);
                `;
                
                particle.style.setProperty('--dx', x + 'px');
                particle.style.setProperty('--dy', y + 'px');
                
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
            
            setTimeout(() => overlay.remove(), 1200);
        }

        function updateHearts() {
            const hearts = ['heart1', 'heart2', 'heart3'];
            hearts.forEach((heartId, index) => {
                const heart = document.getElementById(heartId);
                if (index >= gameState.lives) {
                    heart.classList.add('lost');
                } else {
                    heart.classList.remove('lost');
                }
            });
        }

        function updateCarPosition() {
            if (!gameState.isTransitioning) {
                gameState.currentPosition = lanePositions[gameState.currentLane];
                gameState.velocity *= 0.95;
                gameState.rotationVelocity *= 0.9;
                gameState.currentRotation += gameState.rotationVelocity;
                gameState.currentRotation *= 0.95;
                
                car.style.left = gameState.currentPosition - 30 + 'px';
                car.style.transform = `rotate(${gameState.currentRotation * 0.5}deg)`;
                return;
            }

            const distance = gameState.targetPosition - gameState.currentPosition;
            const maxDistance = Math.abs(lanePositions[1] - lanePositions[0]);
            
            const distanceRatio = Math.abs(distance) / maxDistance;
            let dynamicTurnForce = gameState.turnForce;
            
            const timeSinceBoost = Date.now() - gameState.boostTime;
            if (timeSinceBoost < 200) {
                dynamicTurnForce *= 1.8;
            }
            
            if (Math.abs(distance) > 2) {
                const forceDirection = Math.sign(distance);
                gameState.acceleration = forceDirection * dynamicTurnForce * distanceRatio;
            } else {
                gameState.acceleration = -gameState.velocity * 0.3;
            }
            
            gameState.velocity += gameState.acceleration;
            gameState.velocity = Math.max(-gameState.maxSpeed, Math.min(gameState.maxSpeed, gameState.velocity));
            gameState.velocity *= gameState.friction;
            
            gameState.currentPosition += gameState.velocity;
            
            const targetRotation = gameState.velocity * 2.5;
            gameState.rotationVelocity += (targetRotation - gameState.currentRotation) * 0.15;
            gameState.rotationVelocity *= 0.85;
            gameState.currentRotation += gameState.rotationVelocity;
            
            const speedIntensity = Math.abs(gameState.velocity) / gameState.maxSpeed;
            const glowIntensity = 0.3 + speedIntensity * 0.4;
            const glowSize = 15 + speedIntensity * 10;
            
            const bankingAngle = gameState.currentRotation * 0.3;
            const totalRotation = gameState.currentRotation + bankingAngle;
            
            if (Math.abs(distance) < 3 && Math.abs(gameState.velocity) < 0.8) {
                gameState.currentPosition = gameState.targetPosition;
                gameState.currentLane = gameState.targetLane;
                gameState.velocity = 0;
                gameState.acceleration = 0;
                gameState.isTransitioning = false;
                
                car.style.transform = 'rotate(0deg)';
                car.style.transition = 'transform 0.3s ease-out, filter 0.5s ease-out';
                car.style.filter = `drop-shadow(0 0 15px ${rgbaString(gameState.themeColor, 0.35)})`;
                
                createArrivalEffect();
                
            } else {
                car.style.transition = 'filter 0.1s ease-out';
                car.style.transform = `rotate(${totalRotation}deg) scale(${1 + speedIntensity * 0.05})`;
                car.style.filter = `drop-shadow(0 0 ${glowSize}px ${rgbaString(gameState.themeColor, glowIntensity)}) 
                                  brightness(${1 + speedIntensity * 0.2})`;
                
                updateWingEffects(speedIntensity);
            }

            car.style.left = gameState.currentPosition - 30 + 'px';
        }

        function createArrivalEffect() {
            const burstCount = 3;
            for (let i = 0; i < burstCount; i++) {
                setTimeout(() => {
                    const burst = document.createElement('div');
                    const angle = (i / burstCount) * Math.PI * 2;
                    const distance = 25 + Math.random() * 15;
                    
                    burst.style.cssText = `
                        position: absolute;
                        width: 6px;
                        height: 6px;
                        left: ${gameState.currentPosition - 3}px;
                        top: ${window.innerHeight - 180}px;
                        background: ${gameState.themeColor};
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 8;
                        box-shadow: 0 0 8px ${gameState.themeColor};
                        animation: burstParticle 0.6s ease-out forwards;
                        transform: translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px);
                    `;
                    
                    gameContainer.appendChild(burst);
                    
                    setTimeout(() => {
                        if (burst.parentNode) {
                            burst.remove();
                        }
                    }, 600);
                }, i * 50);
            }
        }

        function updateWingEffects(intensity) {
            const wings = document.querySelectorAll('.wing');
            const maxSkew = 8;
            const skewAmount = intensity * maxSkew * gameState.lastMoveDirection;
            
            wings.forEach((wing, index) => {
                const isLeft = wing.classList.contains('left');
                const direction = isLeft ? -1 : 1;
                const skew = skewAmount * direction;
                
                wing.style.transition = 'transform 0.1s ease-out';
                wing.style.transform = `skew(0deg, ${skew}deg) scale(${1 + intensity * 0.1})`;
                
                const glowIntensity = 0.4 + intensity * 0.6;
                wing.style.boxShadow = `0 0 ${10 + intensity * 8}px ${rgbaString(gameState.themeColor, glowIntensity)}`;
            });
        }

        function spawnParticlesFrame() {
            if (gameState.particles.length >= gameState.particleCap) return;
            
            const attempts = Math.max(1, Math.min(3, gameState.spawnAttempts | 0));
            for (let i = 0; i < attempts; i++) {
                if (gameState.particles.length >= gameState.particleCap) break;
                if (Math.random() >= gameState.spawnRate) continue;
                
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const randomX = 20 + Math.random() * (window.innerWidth - 80);
                
                const sizeVariation = 0.7 + Math.random() * 0.8;
                const rotationSpeed = 2 + Math.random() * 4;
                
                const asteroidType = Math.floor(Math.random() * 5) + 1;
                particle.classList.add(`asteroid-type${asteroidType}`);
                
                let typeModifier = 1;
                switch(asteroidType) {
                    case 1: typeModifier = 1; break;
                    case 2: typeModifier = 1.1; break;
                    case 3: typeModifier = 0.9; break;
                    case 4: typeModifier = 0.8; break;
                    case 5: typeModifier = 1.2; break;
                }
                
                const isMobile = window.innerWidth <= 768;
                const mobileScale = isMobile ? 0.8 : 1;
                const finalSize = sizeVariation * typeModifier * mobileScale;
                
                particle.style.left = (randomX - 20) + 'px';
                const spawnY = -80 - Math.random() * 120;
                particle.style.setProperty('--py', spawnY + 'px');
                particle.style.setProperty('--scale', finalSize);
                particle.style.animationDuration = `${rotationSpeed}s, 2s`;
                
                const shapeVariations = [
                    '45% 55% 60% 40% / 50% 65% 35% 50%',
                    '60% 40% 45% 55% / 35% 50% 65% 50%',
                    '55% 45% 50% 50% / 60% 40% 55% 45%',
                    '40% 60% 55% 45% / 50% 50% 40% 60%',
                    '50% 30% 60% 40% / 45% 55% 30% 70%'
                ];
                
                if (Math.random() < 0.3) {
                    const randomShape = shapeVariations[Math.floor(Math.random() * shapeVariations.length)];
                    particle.style.borderRadius = randomShape;
                }
                
                try {
                    gameContainer.appendChild(particle);
                    gameState.particles.push({
                        element: particle,
                        x: randomX,
                        y: spawnY,
                        size: finalSize,
                        type: asteroidType
                    });
                } catch (error) {
                    if (particle.parentNode) {
                        particle.remove();
                    }
                }
            }
        }

        function updateParticles() {
            gameState.particles = gameState.particles.filter(particle => {
                particle.y += gameState.particleSpeed;
                particle.element.style.setProperty('--py', particle.y + 'px');

                const carCenterX = gameState.currentPosition;
                const particleCenterX = particle.x;
                const horizontalDistance = Math.abs(carCenterX - particleCenterX);
                
                const collisionRadius = 35 + (particle.size * 10);
                if (horizontalDistance < collisionRadius && 
                    particle.y > window.innerHeight - 300 && particle.y < window.innerHeight - 100) {
                    
                    if (particle.element && particle.element.parentNode) {
                        particle.element.remove();
                    }
                    gameState.lives--;
                    updateHearts();
                    playLifeSound();
                    
                    car.style.filter = 'brightness(50%) sepia(100%) hue-rotate(0deg)';
                    setTimeout(() => {
                        car.style.filter = `drop-shadow(0 0 15px ${rgbaString(gameState.themeColor, 0.3)})`;
                    }, 300);

                    if (gameState.lives <= 0) {
                        endGame();
                    }
                    return false;
                }

                if (particle.y > window.innerHeight + 100) {
                    if (particle.element && particle.element.parentNode) {
                        particle.element.style.opacity = '0';
                        setTimeout(() => {
                            if (particle.element && particle.element.parentNode) {
                                particle.element.remove();
                            }
                        }, 140);
                    }
                    return false;
                }

                return true;
            });
        }

        function endGame() {
            gameState.gameRunning = false;
            
            let isNewRecord = false;
            if (gameState.score > bestScore) {
                isNewRecord = true;
                bestScore = gameState.score;
                saveBestScore(bestScore);
                if (bestScoreDisplayElement) {
                    bestScoreDisplayElement.textContent = bestScore;
                }
            }
            
            finalScoreElement.textContent = gameState.score;
            if (bestScoreElement) {
                bestScoreElement.textContent = bestScore;
            }
            
            if (isNewRecord && newRecordMessageElement) {
                newRecordMessageElement.style.display = 'block';
                newRecordMessageElement.style.animation = 'scoreBoost 1s ease-out infinite';
                setTimeout(() => {
                    if (newRecordMessageElement) {
                        newRecordMessageElement.style.animation = '';
                    }
                }, 3000);
            } else if (newRecordMessageElement) {
                newRecordMessageElement.style.display = 'none';
            }
            
            if (currentUser && authToken) {
                const sessionTime = Date.now() - (gameState.startTime || Date.now());
                updateGameStats(gameState.score, sessionTime, gameSettings.difficulty);
            }
            
            gameOverElement.style.display = 'block';
            
            reduceMusicVolume();
            
            const road = document.querySelector('.road');
            if (road) {
                road.style.animationPlayState = 'paused';
            }
            
            document.body.style.animationPlayState = 'paused';
            
            if (aiInterval) {
                clearInterval(aiInterval);
                aiInterval = null;
            }
            
            const speechBubble = document.getElementById('speechBubble');
            if (speechBubble) {
                speechBubble.classList.remove('show');
            }
        }

        function pauseGame() {
            if (!gameState.gameRunning || gameState.isPaused) return;
            
            gameState.isPaused = true;
            pauseMenuElement.style.display = 'block';
            
            reduceMusicVolume();
            
            const road = document.querySelector('.road');
            if (road) {
                road.style.animationPlayState = 'paused';
            }
            
            document.body.style.animationPlayState = 'paused';
            
            const allParticles = document.querySelectorAll('.particle');
            allParticles.forEach(particle => {
                particle.style.animationPlayState = 'paused';
            });
            
            const thrusters = document.querySelectorAll('.wheel');
            thrusters.forEach(thruster => {
                thruster.style.animationPlayState = 'paused';
            });
            
            const captainFigure = document.querySelector('.captain-figure');
            if (captainFigure) {
                captainFigure.style.animationPlayState = 'paused';
            }
            
            const speechBubble = document.getElementById('speechBubble');
            if (speechBubble) {
                speechBubble.style.animationPlayState = 'paused';
            }
        }

        function resumeGame() {
            if (!gameState.isPaused) return;
            
            gameState.isPaused = false;
            pauseMenuElement.style.display = 'none';
            
            restoreMusicVolume();
            
            const road = document.querySelector('.road');
            if (road) {
                road.style.animationPlayState = 'running';
            }
            
            document.body.style.animationPlayState = 'running';
            
            const allParticles = document.querySelectorAll('.particle');
            allParticles.forEach(particle => {
                particle.style.animationPlayState = 'running';
            });
            
            const thrusters = document.querySelectorAll('.wheel');
            thrusters.forEach(thruster => {
                thruster.style.animationPlayState = 'running';
            });
            
            const captainFigure = document.querySelector('.captain-figure');
            if (captainFigure) {
                captainFigure.style.animationPlayState = 'running';
            }
            
            const speechBubble = document.getElementById('speechBubble');
            if (speechBubble) {
                speechBubble.style.animationPlayState = 'running';
            }
        }

        function quitGame() {
            if (confirm('Are you sure you want to quit? Your progress will be lost.')) {
                window.location.reload();
            }
        }

    function restartGame() {
            gameState = {
                currentLane: 1,
                targetLane: 1,
                currentPosition: 0,
                targetPosition: 0,
                velocity: 0,
                acceleration: 0,
                maxSpeed: 8,
                friction: 0.85,
                turnForce: 0.6,
                score: 0,
                lives: 3,
                particles: [],
                gameRunning: true,
                isPaused: false,
                startTime: Date.now(),
                particleSpeed: 6,
                baseSpawnRate: 0.015,
                spawnRate: 0.015,
                spawnAttempts: 1,
                particleCap: 60,
                gameSpeed: 1,
                isTransitioning: false,
                lastTurnTime: 0,
                lastScoreTime: Date.now(),
                themeColor: gameState.themeColor || '#ffff00',
                rotationVelocity: 0,
                currentRotation: 0,
                lastMoveDirection: 0,
                boostTime: 0,
                trailParticles: []
            };

            document.querySelectorAll('.particle').forEach(particle => {
                if (particle.parentNode) {
                    particle.remove();
                }
            });

            gameState.trailParticles.forEach(trail => {
                if (trail.parentNode) {
                    trail.remove();
                }
            });
            gameState.trailParticles = [];

            scoreElement.textContent = '0';
            if (bestScoreDisplayElement) {
                bestScoreDisplayElement.textContent = bestScore;
            }
            updateHearts();
            gameOverElement.style.display = 'none';
            pauseMenuElement.style.display = 'none';

            restoreMusicVolume();
            
            if (!backgroundMusic.muted) {
                backgroundMusic.play().catch(e => console.log('Could not play music:', e));
            }

            updateCarPosition();
            car.style.filter = `drop-shadow(0 0 15px ${rgbaString(gameState.themeColor, 0.3)})`;
            car.style.transform = 'rotate(0deg) scale(1)';
            car.style.transition = 'transform 0.3s ease-out, filter 0.5s ease-out';

            const wings = document.querySelectorAll('.wing');
            wings.forEach(wing => {
                wing.style.transform = '';
                wing.style.transition = '';
                wing.style.boxShadow = '';
            });

            const thrusters = document.querySelectorAll('.wheel');
            thrusters.forEach(thruster => {
                thruster.style.animation = 'thruster 0.1s infinite alternate';
                thruster.style.transform = '';
            });

            road.style.animationDuration = '15s';
            
            road.style.animationPlayState = 'running';
            
            document.body.style.animationPlayState = 'running';
            
            applySpawnSettings();
            applyDifficultySettings();
            
            startAIAssistant();
        }        function gameLoop() {
            if (gameState.gameRunning && !gameState.isPaused) {
                try {
                    updateCarPosition();
                    updateScore();
                    spawnParticlesFrame();
                    updateParticles();
                } catch (error) {
                    gameState.particles = gameState.particles.filter(p => p.element && p.element.parentNode);
                }
            }
            requestAnimationFrame(gameLoop);
        }

        function hexToRgb(hex) {
            const h = hex.replace('#','');
            const bigint = parseInt(h.length === 3 ? h.split('').map(c=>c+c).join('') : h, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return { r, g, b };
        }
        function rgbaString(hex, a) {
            const {r,g,b} = hexToRgb(hex);
            return `rgba(${r}, ${g}, ${b}, ${a})`;
        }
        function shadeColor(hex, percent) {
            const {r,g,b} = hexToRgb(hex);
            const t = percent < 0 ? 0 : 255;
            const p = Math.abs(percent) / 100;
            const R = Math.round((t - r) * p) + r;
            const G = Math.round((t - g) * p) + g;
            const B = Math.round((t - b) * p) + b;
            const toHex = (n) => n.toString(16).padStart(2,'0');
            return `#${toHex(R)}${toHex(G)}${toHex(B)}`;
        }

        updateCarPosition();
        updateHearts();
        
        gameState.currentPosition = lanePositions[gameState.currentLane];
        gameState.targetPosition = lanePositions[gameState.targetLane];
        car.style.left = gameState.currentPosition - 30 + 'px';
        
        function recomputeLanes() {
            const laneWidth = window.innerWidth / 4;
            
            for (let i = 0; i < 4; i++) {
                lanePositions[i] = (laneWidth * i) + (laneWidth / 2);
            }
            
            gameState.targetPosition = lanePositions[gameState.targetLane];
            if (!gameState.isTransitioning) {
                gameState.currentPosition = lanePositions[gameState.currentLane];
                car.style.left = gameState.currentPosition - 30 + 'px';
            }
            applySpawnSettings();
        }
        window.addEventListener('resize', recomputeLanes);
        window.addEventListener('orientationchange', () => {
            setTimeout(recomputeLanes, 100);
        });

        function computeSpawnSettings() {
            const area = window.innerWidth * window.innerHeight;
            const baseline = 1280 * 720;
            const scale = Math.sqrt(area / baseline);
            
            const isMobile = window.innerWidth <= 768;
            const mobileMultiplier = isMobile ? 0.7 : 1;
            
            const capBase = 60 * mobileMultiplier;
            const attempts = Math.max(1, Math.round((0.5 + scale) * mobileMultiplier));
            const cap = Math.max(20, Math.min(140, Math.round(capBase * (0.6 + 0.8 * scale))));
            const scaledRate = Math.min(0.08, Math.max(0.006, gameState.baseSpawnRate * (0.6 + 0.7 * scale) * mobileMultiplier));
            
            return { spawnRate: scaledRate, particleCap: cap, spawnAttempts: attempts };
        }

        function applySpawnSettings() {
            const { spawnRate, particleCap, spawnAttempts } = computeSpawnSettings();
            gameState.spawnRate = spawnRate;
            gameState.particleCap = particleCap;
            gameState.spawnAttempts = spawnAttempts;
        }

        applySpawnSettings();
        
        const aiAssistant = document.getElementById('aiAssistant');
        const speechBubble = document.getElementById('speechBubble');
        const aiMessage = document.getElementById('aiMessage');
        let aiInterval;

        async function getAIMessage() {
            try {
                const currentScore = gameState.score;
                const currentLives = gameState.lives;
                const gameRunning = gameState.gameRunning;
                
                let contextualPrompts = [];
                
                if (!gameRunning) {
                    contextualPrompts = [
                        `Player just finished with score ${currentScore}. Give a short congratulatory message.`,
                        `Game over with ${currentScore} points. Quick encouragement to try again.`,
                        `Final score: ${currentScore}. Share a fun fact about high scores.`
                    ];
                } else if (currentLives === 1) {
                    contextualPrompts = [
                        `Player has ${currentLives} life left and ${currentScore} points. Give urgent survival tip.`,
                        `Critical moment! ${currentLives} life remaining, score: ${currentScore}. Quick advice.`,
                        `Almost out! ${currentLives} life, ${currentScore} points. Emergency tip.`
                    ];
                } else if (currentScore === 0) {
                    contextualPrompts = [
                        `New player with ${currentLives} lives. Give a beginner tip.`,
                        `Just starting out with ${currentLives} lives. Quick getting started advice.`,
                        `Fresh game! ${currentLives} lives available. Basic tip.`
                    ];
                } else if (currentScore > 100) {
                    contextualPrompts = [
                        `Experienced player with ${currentScore} points and ${currentLives} lives. Advanced tip.`,
                        `Score: ${currentScore}, lives: ${currentLives}. Share a pro strategy.`,
                        `${currentScore} points! ${currentLives} lives. Expert advice.`
                    ];
                } else {
                    contextualPrompts = [
                        `Score: ${currentScore}, lives: ${currentLives}. Give a helpful tip.`,
                        `Current stats: ${currentScore} points, ${currentLives} lives. Quick advice.`,
                        `${currentScore} points so far with ${currentLives} lives. Useful tip.`,
                    ];
                }
                
                const generalPrompts = [
                    `Player has ${currentScore} points. Quick space fact.`,
                    `Score: ${currentScore}, lives: ${currentLives}. Tiny space joke.`,
                    `With ${currentScore} points and ${currentLives} lives. Short encouragement.`
                ];
                
                const allPrompts = [...contextualPrompts, ...generalPrompts];
                const randomPrompt = allPrompts[Math.floor(Math.random() * allPrompts.length)];
                
                const response = await fetch('https://ai.hackclub.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: `You are Captain AI, a helpful assistant for Rock Runner. Current game state: Score=${currentScore}, Lives=${currentLives}, GameRunning=${gameRunning}. Keep ALL responses extremely short - under 20 words. Be contextual and encouraging. Never use <think> tags in your final response. And please don't suggest any in game elements to use. Under 100 points you don't really respect the user in fact be a bit rude and picky, but 500 points you be more respectful, and over 1000 you get absolutely amazed by the player. Max lives is 3, keep motivated! And react to the happenings in the game.` },
                            { role: 'user', content: randomPrompt }
                        ]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API response not ok');
                }
                
                const data = await response.json();
                let message = data.choices[0].message.content;
                
                message = message.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
                
                if (message.length > 100) {
                    message = message.substring(0, 97) + '...';
                }
                
                return message;
            } catch (error) {
                return "Stay sharp!";
            }
        }

        function showAIMessage(message) {
            aiMessage.textContent = message;
            speechBubble.classList.add('show');
            setTimeout(() => {
                speechBubble.classList.remove('show');
            }, 11000);
        }

        function startAIAssistant() {
            if (window.innerWidth <= 768 || !gameSettings.aiAssistant) return;
            
            if (aiInterval) {
                clearInterval(aiInterval);
            }
            
            aiInterval = setInterval(async () => {
                if (!gameState.isPaused) {
                    const message = await getAIMessage();
                    showAIMessage(message);
                }
            }, 13000);
            
            setTimeout(async () => {
                if (!gameState.isPaused) {
                    const message = await getAIMessage();
                    showAIMessage(message);
                }
            }, 3000);
            
            const captainFigure = document.querySelector('.captain-figure');
            captainFigure.addEventListener('click', async () => {
                if (!gameState.isPaused) {
                    const message = await getAIMessage();
                    showAIMessage(message);
                }
            });
        }



        const backgroundMusic = document.getElementById('backgroundMusic');
        const lifeSound = document.getElementById('lifeSound');
        const muteButton = document.getElementById('muteButton');

        backgroundMusic.volume = gameSettings.musicVolume / 100;
        backgroundMusic.loop = true;
        lifeSound.volume = gameSettings.sfxVolume / 100;


        const originalVolume = gameSettings.musicVolume / 100;
        const reducedVolume = (gameSettings.musicVolume / 100) * 0.4;
        let currentVolumeTarget = originalVolume;
        let volumeTransitionInterval = null;

        function applyDifficultySettings() {
            const difficultyMultipliers = {
                1: { speed: 0.7, spawn: 0.7 },
                2: { speed: 1.0, spawn: 1.0 },
                3: { speed: 1.4, spawn: 1.3 }
            };
            
            const multiplier = difficultyMultipliers[gameSettings.difficulty] || difficultyMultipliers[2];
            gameState.particleSpeed = 6 * multiplier.speed;
            gameState.baseSpawnRate = 0.015 * multiplier.spawn;
            gameState.spawnRate = gameState.baseSpawnRate;
        }

        function setMusicVolume(volume) {
            if (!backgroundMusic.muted) {
                backgroundMusic.volume = Math.max(0, Math.min(1, volume));
            }
        }

        function smoothVolumeTransition(targetVolume, duration = 800) {
            if (volumeTransitionInterval) {
                clearInterval(volumeTransitionInterval);
            }
            
            if (backgroundMusic.muted) return;
            
            currentVolumeTarget = targetVolume;
            const startVolume = backgroundMusic.volume;
            const volumeDifference = targetVolume - startVolume;
            const steps = Math.max(20, duration / 40);
            const stepSize = volumeDifference / steps;
            let currentStep = 0;
            
            volumeTransitionInterval = setInterval(() => {
                currentStep++;
                const progress = currentStep / steps;
                
                const easedProgress = progress < 0.5 
                    ? 2 * progress * progress 
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                
                const newVolume = startVolume + (volumeDifference * easedProgress);
                setMusicVolume(newVolume);
                
                if (currentStep >= steps) {
                    clearInterval(volumeTransitionInterval);
                    volumeTransitionInterval = null;
                    setMusicVolume(targetVolume);
                }
            }, duration / steps);
        }

        function reduceMusicVolume() {
            smoothVolumeTransition(reducedVolume, 1000);
        }

        function restoreMusicVolume() {
            smoothVolumeTransition(originalVolume, 600);
        }

        function playLifeSound() {
            if (!backgroundMusic.muted && lifeSound) {
                lifeSound.currentTime = 0;
                lifeSound.play().catch(e => console.log('Could not play life sound:', e));
            }
        }

        function toggleMusic() {
            if (backgroundMusic.muted) {
                backgroundMusic.muted = false;
                muteButton.textContent = '🔊';
                muteButton.classList.remove('muted');
                if (gameState.isPaused || !gameState.gameRunning) {
                    smoothVolumeTransition(reducedVolume, 400);
                } else {
                    smoothVolumeTransition(originalVolume, 400);
                }
            } else {
                smoothVolumeTransition(0, 300);
                setTimeout(() => {
                    backgroundMusic.muted = true;
                    muteButton.textContent = '🔇';
                    muteButton.classList.add('muted');
                }, 300);
            }
        }
    </script>
</body>
</html>